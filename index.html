<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Pricing ML | Sistema de Gestão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' },
                    },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        .input-label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; display: block; }
        .input-field { width: 100%; padding: 0.5rem 0.75rem; background-color: #fff; border: 1px solid #cbd5e1; border-radius: 0.375rem; font-size: 0.875rem; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #0d9488; ring: 2px; box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.1); }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        @media print {
            body { background: white; }
            #sidebar, #login-screen, .no-print { display: none !important; }
            #main-content { margin: 0; padding: 0; height: auto; overflow: visible; }
            .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; margin-bottom: 20px; }
            .print-only-header { display: block !important; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
        }
        .print-only-header { display: none; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen overflow-hidden flex">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-brand-400 to-brand-600"></div>
            
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4 text-brand-600 text-2xl">
                    <i class="fa-solid fa-chart-line"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Smart Pricing ML</h1>
                <p class="text-slate-500 text-sm mt-1">Gestão de Precificação Inteligente</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="input-label">Email</label>
                    <div class="relative">
                        <i class="fa-solid fa-envelope absolute left-3 top-3 text-slate-400"></i>
                        <input type="email" id="email" class="input-field pl-10" placeholder="seu@email.com" required>
                    </div>
                </div>
                <div>
                    <label class="input-label">Senha</label>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-3 top-3 text-slate-400"></i>
                        <input type="password" id="password" class="input-field pl-10" placeholder="••••••••" required>
                    </div>
                </div>
                
                <div id="authError" class="text-red-500 text-xs text-center hidden"></div>

                <div class="flex gap-3 pt-2">
                    <button type="button" id="btnLogin" class="flex-1 bg-brand-600 hover:bg-brand-700 text-white py-2.5 rounded-lg font-semibold transition-colors shadow-lg shadow-brand-500/30">
                        Entrar
                    </button>
                    <button type="button" id="btnRegister" class="flex-1 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 py-2.5 rounded-lg font-semibold transition-colors">
                        Cadastrar
                    </button>
                </div>
            </form>
            <p class="text-center text-xs text-slate-400 mt-6">v3.1.0 - Stable Edition</p>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-white flex-col hidden md:flex transition-all z-20">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <i class="fa-solid fa-chart-pie text-brand-500 mr-3 text-xl"></i>
            <span class="font-bold text-lg tracking-tight">Smart Pricing</span>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
            <p class="text-xs font-bold text-slate-500 uppercase px-2 mb-2">Módulos</p>
            <button onclick="switchTab('calculator')" id="nav-calc" class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium bg-brand-600 text-white rounded-lg transition-colors">
                <i class="fa-solid fa-calculator w-5"></i> Calculadora
            </button>
            <button onclick="switchTab('products')" id="nav-prod" class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors">
                <i class="fa-solid fa-boxes-stacked w-5"></i> Meus Produtos
            </button>

            <div class="pt-6 mt-6 border-t border-slate-800">
                <p class="text-xs font-bold text-slate-500 uppercase px-2 mb-2">Dados & Backup</p>
                <button id="btnBackup" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-brand-400 hover:bg-slate-800 rounded-lg">
                    <i class="fa-solid fa-download w-5"></i> Backup (JSON)
                </button>
                <label for="fileImport" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-slate-400 hover:text-brand-400 hover:bg-slate-800 rounded-lg cursor-pointer">
                    <i class="fa-solid fa-upload w-5"></i> Importar
                    <input type="file" id="fileImport" accept=".json" class="hidden">
                </label>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-950">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">
                    <i class="fa-solid fa-user text-xs"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <p id="userEmailDisplay" class="text-sm font-medium truncate">Carregando...</p>
                    <p class="text-xs text-brand-500">Online</p>
                </div>
            </div>
            <button id="btnLogout" class="w-full text-xs text-slate-500 hover:text-red-400 text-left flex items-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> Sair do Sistema
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 h-screen overflow-y-auto bg-slate-50 relative hidden">
        <div class="print-only-header">
            <h1 class="text-2xl font-bold">Relatório de Custo e Precificação</h1>
            <p class="text-sm text-gray-500">Gerado pelo Sistema Smart Pricing ML</p>
        </div>

        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 sticky top-0 z-10 no-print">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-slate-500" onclick="document.getElementById('sidebar').classList.toggle('hidden')">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <h2 id="pageTitle" class="text-lg font-semibold text-slate-800">Calculadora de Custos</h2>
            </div>
            <div class="flex items-center gap-3">
                <div id="calc-actions" class="flex gap-2">
                    <button onclick="resetCalculator()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded border border-slate-200">
                        <i class="fa-solid fa-plus mr-1"></i> Novo
                    </button>
                    <button onclick="printReport()" class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded border border-slate-200">
                        <i class="fa-solid fa-print mr-1"></i> Imprimir
                    </button>
                    <button id="btnSave" class="px-4 py-1.5 text-xs font-bold text-white bg-brand-600 hover:bg-brand-700 rounded shadow-sm flex items-center gap-2 transition-all">
                        <i class="fa-solid fa-save"></i> <span id="btnSaveText">Salvar</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="p-6 max-w-7xl mx-auto space-y-6">
            <div id="view-calculator" class="animate-fade-in space-y-6">
                <div id="aiInsightsPanel" class="hidden"></div>
                <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
                    <div class="xl:col-span-7 space-y-6">
                        <div class="card p-6 border-l-4 border-brand-500">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-box text-brand-500"></i> Dados do Produto
                            </h3>
                            <input type="hidden" id="currentDocId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="input-label">SKU</label><input type="text" id="sku" class="input-field uppercase font-mono" placeholder="EX: CAM-001"></div>
                                <div><label class="input-label">Título (Opcional)</label><input type="text" id="productName" class="input-field" placeholder="Nome do produto"></div>
                                <div><label class="input-label">Custo (CMV) R$</label><input type="number" id="costPrice" class="input-field" value="35.00" step="0.01"></div>
                                <div><label class="input-label">Margem Meta %</label><input type="number" id="margin" class="input-field" value="20.0" step="0.1"></div>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-truck-fast text-blue-600"></i> Logística (2025)
                            </h3>
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div><label class="input-label">Alt (cm)</label><input type="number" id="dimH" class="input-field" placeholder="0"></div>
                                <div><label class="input-label">Larg (cm)</label><input type="number" id="dimW" class="input-field" placeholder="0"></div>
                                <div><label class="input-label">Comp (cm)</label><input type="number" id="dimL" class="input-field" placeholder="0"></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="input-label">Peso Físico (kg)</label><input type="number" id="weight" class="input-field" placeholder="0.5" step="0.1"></div>
                                <div class="bg-blue-50 border border-blue-100 rounded p-2 flex flex-col justify-center text-center">
                                    <span class="text-[10px] font-bold text-blue-600 uppercase">Peso IATA</span>
                                    <span id="finalWeightDisplay" class="font-bold text-blue-800 text-lg">0.00 kg</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div><label class="input-label">Reputação</label><select id="reputation" class="input-field"><option value="verde_lider">MercadoLíder</option><option value="verde">Verde</option><option value="amarela">Amarela</option><option value="laranja">Laranja/Vermelha</option></select></div>
                                <div><label class="input-label">Frete em < R$79</label><select id="freeShippingLowPrice" class="input-field"><option value="nao">Comprador Paga</option><option value="sim">Frete Grátis</option></select></div>
                            </div>
                        </div>
                         <div class="card p-6">
                            <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-tags text-purple-600"></i> Taxas & Ads
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="input-label">Categoria</label><select id="category" class="input-field"><option value="roupas">Roupas (12%/17%)</option><option value="eletronicos">Eletrônicos (11.5%/16.5%)</option><option value="beleza">Beleza (12.5%/17.5%)</option><option value="casa">Casa (11%/16%)</option><option value="outros">Geral (11%/16%)</option></select></div>
                                <div><label class="input-label">Tipo Anúncio</label><select id="listingType" class="input-field"><option value="premium">Premium (Sem Juros)</option><option value="classico">Clássico</option></select></div>
                                <div><label class="input-label">Imposto %</label><input type="number" id="taxRate" class="input-field" value="4.0"></div>
                                <div><label class="input-label">Ads (ACOS) %</label><input type="number" id="acos" class="input-field" value="5.0"></div>
                            </div>
                        </div>
                    </div>
                    <div class="xl:col-span-5 space-y-6">
                        <div class="card bg-slate-900 text-white p-6 border-0 relative overflow-hidden shadow-xl">
                            <div class="relative z-10 text-center">
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Preço Sugerido</p>
                                <h2 id="finalPriceDisplay" class="text-5xl font-bold text-brand-400">R$ 0,00</h2>
                                <p class="text-sm text-slate-400 mt-2">Lucro Líquido: <span id="summaryProfit" class="text-white font-bold">R$ 0,00</span></p>
                            </div>
                        </div>
                        <div class="card p-6">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 pb-2 border-b">Detalhamento Financeiro</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between font-medium"><span>Venda Bruta</span><span id="summaryRevenue">R$ 0,00</span></div>
                                <div class="pl-3 border-l-2 border-red-100 space-y-1 text-xs text-red-600">
                                    <div class="flex justify-between"><span>Tarifa ML <span id="feePercDisplay"></span></span><span id="summaryFee">R$ 0,00</span></div>
                                    <div class="flex justify-between"><span>Taxa Fixa</span><span id="summaryFlatFee">R$ 0,00</span></div>
                                    <div class="flex justify-between"><span>Frete</span><span id="summaryShipping">R$ 0,00</span></div>
                                    <div class="flex justify-between"><span>Impostos</span><span id="summaryTax">R$ 0,00</span></div>
                                    <div class="flex justify-between text-purple-600"><span>Ads</span><span id="summaryAds">R$ 0,00</span></div>
                                </div>
                                <div class="flex justify-between text-xs text-slate-500 pt-2"><span>(-) Custo Produto</span><span id="summaryCost">R$ 0,00</span></div>
                                <div class="bg-emerald-50 p-3 rounded mt-2 border border-emerald-100 flex justify-between items-center">
                                    <span class="text-emerald-800 font-bold">Margem Líquida</span>
                                    <span id="summaryMargin" class="text-emerald-600 font-bold">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="card p-4 h-64 flex flex-col">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Gráfico de Distribuição</h4>
                            <div class="flex-1 relative"><canvas id="costChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-products" class="hidden animate-fade-in">
                <div class="card overflow-hidden">
                    <div class="p-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="relative w-full md:w-64">
                            <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                            <input type="text" id="searchProduct" placeholder="Buscar por SKU ou Nome..." class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:border-brand-500">
                        </div>
                        <div class="text-xs text-slate-500">
                            Total: <span id="totalProductsCount" class="font-bold text-slate-800">0</span> produtos
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                                <tr>
                                    <th class="px-6 py-3">SKU / Produto</th>
                                    <th class="px-6 py-3">Custo</th>
                                    <th class="px-6 py-3 text-right">Preço Venda</th>
                                    <th class="px-6 py-3 text-right">Margem</th>
                                    <th class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody" class="divide-y divide-slate-100">
                                <tr><td colspan="5" class="px-6 py-8 text-center text-slate-400 italic"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Carregando produtos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithCustomToken, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBfsctDhi_AcqU6PTpWO6W4TBeA0tuwjkM",
            authDomain: "gerador-prompt.firebaseapp.com",
            projectId: "gerador-prompt",
            storageBucket: "gerador-prompt.firebasestorage.app",
            messagingSenderId: "595983997758",
            appId: "1:595983997758:web:25263e89f476fa7ae1aa6f"
        };
        
        // --- CONSTANT APP ID MATCHING RULES ---
        const appId = 'smart-pricing-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let productsUnsubscribe = null;
        let allProductsCache = [];

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const loginScreen = document.getElementById('login-screen');
            const mainContent = document.getElementById('main-content');
            const sidebar = document.getElementById('sidebar');

            if (user) {
                loginScreen.classList.add('hidden');
                mainContent.classList.remove('hidden');
                if(window.innerWidth >= 768) sidebar.classList.remove('hidden');
                document.getElementById('userEmailDisplay').textContent = user.email || 'Usuário Anônimo';
                loadProductsRealtime();
            } else {
                loginScreen.classList.remove('hidden');
                mainContent.classList.add('hidden');
                sidebar.classList.add('hidden');
                if(productsUnsubscribe) productsUnsubscribe();
            }
        });

        document.getElementById('btnLogin').addEventListener('click', async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, e, p); } 
            catch (err) { showAuthError("Erro ao entrar: " + err.message); }
        });

        document.getElementById('btnRegister').addEventListener('click', async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try { await createUserWithEmailAndPassword(auth, e, p); } 
            catch (err) { showAuthError("Erro ao cadastrar: " + err.message); }
        });

        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

        function showAuthError(msg) {
            const el = document.getElementById('authError');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        document.getElementById('btnSave').addEventListener('click', async () => {
            if(!currentUser) { alert("Você precisa estar logado."); return; }
            
            const btn = document.getElementById('btnSave');
            const docId = document.getElementById('currentDocId').value;
            const isEdit = !!docId;

            const data = {
                sku: document.getElementById('sku').value.toUpperCase() || 'SEM-SKU',
                name: document.getElementById('productName').value,
                costPrice: parseFloat(document.getElementById('costPrice').value),
                margin: parseFloat(document.getElementById('margin').value),
                finalPrice: document.getElementById('finalPriceDisplay').innerText,
                profit: document.getElementById('summaryProfit').innerText,
                updatedAt: new Date().toISOString(),
                inputs: {
                    dimH: document.getElementById('dimH').value,
                    dimW: document.getElementById('dimW').value,
                    dimL: document.getElementById('dimL').value,
                    weight: document.getElementById('weight').value,
                    reputation: document.getElementById('reputation').value,
                    freeShippingLowPrice: document.getElementById('freeShippingLowPrice').value,
                    category: document.getElementById('category').value,
                    listingType: document.getElementById('listingType').value,
                    taxRate: document.getElementById('taxRate').value,
                    acos: document.getElementById('acos').value
                }
            };

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // FIXED PATH: smart-pricing-app
                const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products');
                
                if (isEdit) {
                    await updateDoc(doc(colRef, docId), data);
                    alert("Produto atualizado com sucesso!");
                } else {
                    data.createdAt = new Date().toISOString();
                    const docRef = await addDoc(colRef, data);
                    document.getElementById('currentDocId').value = docRef.id;
                    alert("Produto salvo com sucesso!");
                }
            } catch (e) {
                console.error("Save Error:", e);
                if (e.code === 'permission-denied') {
                    alert("Erro de Permissão (Firestore).\nVerifique se você copiou as regras corretamente no Console do Firebase.");
                } else {
                    alert("Erro ao salvar: " + e.message);
                }
            } finally {
                const currentId = document.getElementById('currentDocId').value;
                const label = currentId ? 'Atualizar' : 'Salvar';
                btn.innerHTML = `<i class="fa-solid fa-save"></i> <span id="btnSaveText">${label}</span>`;
                btn.disabled = false;
            }
        });

        function loadProductsRealtime() {
            if (!currentUser) return;
            
            // FIXED PATH MATCH
            const q = query(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products'));
            
            productsUnsubscribe = onSnapshot(q, (snapshot) => {
                allProductsCache = [];
                snapshot.forEach(doc => allProductsCache.push({ id: doc.id, ...doc.data() }));
                renderProductsTable(allProductsCache);
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                if (error.code === 'permission-denied') {
                    document.getElementById('productsTableBody').innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-500 font-bold">Acesso Negado (Regras).</td></tr>`;
                }
            });
        }

        document.getElementById('btnBackup').addEventListener('click', () => {
            if(!allProductsCache.length) return alert("Sem dados para backup.");
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allProductsCache));
            const node = document.createElement('a');
            node.setAttribute("href", dataStr);
            node.setAttribute("download", "backup_precificacao_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(node);
            node.click();
            node.remove();
        });

        document.getElementById('fileImport').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const items = JSON.parse(event.target.result);
                    if(!Array.isArray(items)) throw new Error("Formato inválido");
                    if(!confirm(`Importar ${items.length} produtos?`)) return;
                    const colRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products');
                    let count = 0;
                    for(const item of items) {
                        const { id, ...data } = item;
                        data.importedAt = new Date().toISOString();
                        await addDoc(colRef, data);
                        count++;
                    }
                    alert(`${count} produtos importados!`);
                } catch(err) { alert("Erro: " + err.message); }
            };
            reader.readAsText(file);
        });

        window.loadProductIntoCalc = (id) => {
            const product = allProductsCache.find(p => p.id === id);
            if(!product) return;
            switchTab('calculator');
            document.getElementById('currentDocId').value = product.id;
            document.getElementById('btnSaveText').textContent = "Atualizar";
            document.getElementById('sku').value = product.sku || '';
            document.getElementById('productName').value = product.name || '';
            document.getElementById('costPrice').value = product.costPrice;
            document.getElementById('margin').value = product.margin;
            if(product.inputs) {
                const map = {dimH:'dimH', dimW:'dimW', dimL:'dimL', weight:'weight', reputation:'reputation', freeShippingLowPrice:'freeShippingLowPrice', category:'category', listingType:'listingType', taxRate:'taxRate', acos:'acos'};
                for(let key in map) if(product.inputs[key] !== undefined) document.getElementById(map[key]).value = product.inputs[key];
            }
            document.getElementById('costPrice').dispatchEvent(new Event('input'));
        };

        window.deleteProduct = async (id) => {
            if(confirm("Excluir este produto?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'products', id));
            }
        };
    </script>

    <script>
        function switchTab(tab) {
            const calcView = document.getElementById('view-calculator');
            const prodView = document.getElementById('view-products');
            const navCalc = document.getElementById('nav-calc');
            const navProd = document.getElementById('nav-prod');
            const pageTitle = document.getElementById('pageTitle');
            const calcActions = document.getElementById('calc-actions');

            if(tab === 'calculator') {
                calcView.classList.remove('hidden'); prodView.classList.add('hidden');
                navCalc.className = "w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium bg-brand-600 text-white rounded-lg transition-colors";
                navProd.className = "w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors";
                pageTitle.textContent = "Calculadora de Custos"; calcActions.classList.remove('hidden');
            } else {
                calcView.classList.add('hidden'); prodView.classList.remove('hidden');
                navProd.className = "w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium bg-brand-600 text-white rounded-lg transition-colors";
                navCalc.className = "w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-slate-400 hover:bg-slate-800 hover:text-white rounded-lg transition-colors";
                pageTitle.textContent = "Meus Produtos"; calcActions.classList.add('hidden');
            }
        }

        function resetCalculator() {
            document.getElementById('currentDocId').value = "";
            document.getElementById('btnSaveText').textContent = "Salvar";
            document.getElementById('sku').value = "";
            document.getElementById('productName').value = "";
            document.getElementById('costPrice').value = "35.00";
            document.getElementById('margin').value = "20.0";
            document.getElementById('costPrice').dispatchEvent(new Event('input'));
        }

        function renderProductsTable(products) {
            const tbody = document.getElementById('productsTableBody');
            const searchVal = document.getElementById('searchProduct').value.toLowerCase();
            const countEl = document.getElementById('totalProductsCount');
            tbody.innerHTML = '';
            const filtered = products.filter(p => (p.sku && p.sku.toLowerCase().includes(searchVal)) || (p.name && p.name.toLowerCase().includes(searchVal)));
            countEl.textContent = filtered.length;
            if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">Nenhum produto encontrado.</td></tr>`; return; }
            filtered.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors group";
                tr.innerHTML = `<td class="px-6 py-4"><div class="flex items-center"><div class="h-8 w-8 rounded bg-brand-50 text-brand-600 flex items-center justify-center text-xs font-bold mr-3">${p.sku.substring(0,2)}</div><div><div class="font-medium text-slate-900">${p.sku}</div><div class="text-xs text-slate-500">${p.name || 'Sem nome'}</div></div></div></td><td class="px-6 py-4 text-xs">R$ ${parseFloat(p.costPrice).toFixed(2)}</td><td class="px-6 py-4 text-right font-medium text-brand-600">${p.finalPrice}</td><td class="px-6 py-4 text-right text-xs">${p.margin}%</td><td class="px-6 py-4 text-right"><button onclick="window.loadProductIntoCalc('${p.id}')" class="text-slate-400 hover:text-brand-600 mx-2 transition-colors"><i class="fa-solid fa-pen"></i></button><button onclick="window.deleteProduct('${p.id}')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('searchProduct').addEventListener('keyup', function() {
            renderProductsTable(window.allProductsCache || []); 
        });

        function printReport() { window.print(); }

        const FLAT_FEES = [{ max: 12.50, fee: 0 }, { max: 29.00, fee: 6.25 }, { max: 50.00, fee: 6.50 }, { max: 79.00, fee: 6.75 }, { max: Infinity, fee: 0 }];
        const CAT_FEES = { roupas: { premium: 0.17, classico: 0.12 }, eletronicos: { premium: 0.165, classico: 0.115 }, beleza: { premium: 0.175, classico: 0.125 }, casa: { premium: 0.16, classico: 0.11 }, outros: { premium: 0.16, classico: 0.11 } };
        const SHIPPING_BASE = 32.90;
        const DISCOUNTS = { verde_lider: 0.6, verde: 0.5, amarela: 0.4, laranja: 0 };
        
        let chartInstance = null;
        const fmt = val => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const val = id => parseFloat(document.getElementById(id).value) || 0;

        function updateCalc() {
            const cost = val('costPrice');
            const margin = val('margin') / 100;
            const tax = val('taxRate') / 100;
            const acos = val('acos') / 100;
            
            const cat = document.getElementById('category').value;
            const type = document.getElementById('listingType').value;
            const feeRate = CAT_FEES[cat][type];
            const rep = document.getElementById('reputation').value;
            const forceFreeShip = document.getElementById('freeShippingLowPrice').value;

            const h = val('dimH'), w = val('dimW'), l = val('dimL'), wei = val('weight');
            const vol = (h*w*l)/6000;
            const finalW = Math.max(wei, vol);
            document.getElementById('finalWeightDisplay').textContent = finalW.toFixed(2) + " kg";

            let price = 0, oldPrice = -1, i = 0;
            let flat = 0, ship = 0;
            const denom = 1 - margin - feeRate - tax - acos;

            if(denom <= 0) return document.getElementById('finalPriceDisplay').textContent = "Erro Margem";

            while(Math.abs(price - oldPrice) > 0.01 && i < 20) {
                oldPrice = price;
                flat = 0;
                for(let t of FLAT_FEES) { if(oldPrice <= t.max) { flat = t.fee; break; } }
                if(oldPrice >= 79) flat = 0;
                ship = 0;
                if(oldPrice >= 79 || forceFreeShip === 'sim') { ship = SHIPPING_BASE * (1 - DISCOUNTS[rep]); }
                price = (cost + flat + ship) / denom;
                i++;
                if(oldPrice === -1) oldPrice = 0;
            }

            const feeVal = price * feeRate;
            const taxVal = price * tax;
            const adsVal = price * acos;
            const profit = price - (cost + feeVal + flat + ship + taxVal + adsVal);
            const marginReal = price > 0 ? (profit/price)*100 : 0;

            document.getElementById('finalPriceDisplay').textContent = fmt(price);
            document.getElementById('summaryProfit').textContent = fmt(profit);
            document.getElementById('summaryRevenue').textContent = fmt(price);
            document.getElementById('feePercDisplay').textContent = `(${(feeRate*100).toFixed(1)}%)`;
            document.getElementById('summaryFee').textContent = fmt(feeVal);
            document.getElementById('summaryFlatFee').textContent = fmt(flat);
            document.getElementById('summaryShipping').textContent = fmt(ship);
            document.getElementById('summaryTax').textContent = fmt(taxVal);
            document.getElementById('summaryAds').textContent = fmt(adsVal);
            document.getElementById('summaryCost').textContent = fmt(cost);
            document.getElementById('summaryMargin').textContent = marginReal.toFixed(2) + "%";

            updateChart(profit, cost, feeVal, flat, ship, taxVal, adsVal);
            checkInsights(price, profit, cost, ship, flat, feeRate, tax, acos);
        }

        function updateChart(prof, cost, fee, flat, ship, tax, ads) {
            const ctx = document.getElementById('costChart').getContext('2d');
            const data = [prof, cost, fee, flat, ship, tax, ads].map(v => Math.max(0,v));
            if(chartInstance) { chartInstance.data.datasets[0].data = data; chartInstance.update(); } 
            else { chartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Lucro', 'Custo', 'Tarifa', 'Fixo', 'Frete', 'Imposto', 'Ads'], datasets: [{ data: data, backgroundColor: ['#10b981', '#64748b', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } } }); }
        }

        function checkInsights(price, profit, cost, ship, flat, feeRate, tax, acos) {
            const panel = document.getElementById('aiInsightsPanel');
            if(price >= 79 && price <= 95) {
                const altPrice = 78.90;
                const altProfit = altPrice - (cost + (altPrice*feeRate) + 6.75 + 0 + (altPrice*tax) + (altPrice*acos));
                if(altProfit > profit) { panel.classList.remove('hidden'); panel.innerHTML = `<div class="bg-amber-50 text-amber-800 p-3 rounded border border-amber-200 text-sm flex gap-3"><i class="fa-solid fa-triangle-exclamation mt-1"></i><div><strong>Zona de Perigo (Price Cliff)</strong><br>Vender a R$ 78,90 aumenta seu lucro em ${fmt(altProfit - profit)}.</div></div>`; return; }
            }
            panel.classList.add('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', updateCalc));
            updateCalc();
        });
    </script>
</body>
</html>
